name: Searcade 保号登录

on:
  schedule:
    - cron: '6 6 */3 * *'    # 每3天运行一次，UTC 06:06
  workflow_dispatch:         # 支持手动触发

jobs:
  login:
    runs-on: ubuntu-latest

    steps:
      - name: 签出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install playwright requests playwright-stealth==1.0.6   # 固定旧版，兼容 stealth_async
          playwright install --with-deps chromium
          # 调试：打印版本确认
          pip show playwright-stealth

      - name: 创建截图目录
        run: |
          mkdir -p screenshots
          echo "当前目录结构："
          ls -la

      - name: 运行登录脚本
        env:
          SEARCADE_ACCOUNTS: ${{ secrets.SEARCADE_ACCOUNTS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python login.py

      - name: 上传所有截图作为 artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: searcade-login-screenshots
          path: screenshots/*.png
          if-no-files-found: warn
          retention-days: 14

      - name: 发送截图到 Telegram（使用 sendPhoto）
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "缺少 Telegram Bot Token 或 Chat ID，跳过发送"
            exit 0
          fi

          echo "查找截图文件..."
          ls -la screenshots/ || true

          found=false
          for file in screenshots/*.png; do
            if [ -f "$file" ]; then
              found=true
              filename=$(basename "$file")
              echo "正在发送: $filename"
              curl -s -F chat_id="$TELEGRAM_CHAT_ID" \
                   -F caption="Searcade 保号登录截图 | $(date '+%Y-%m-%d %H:%M:%S') UTC | 作业状态: ${{ job.status }} | 文件: $filename" \
                   -F photo=@"$file" \
                   https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendPhoto
              sleep 2  # 避免 Telegram flood limit
            fi
          done

          if [ "$found" = false ]; then
            echo "没有找到任何截图，发送文字通知"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                 -d chat_id="$TELEGRAM_CHAT_ID" \
                 -d parse_mode="HTML" \
                 -d text="<b>Searcade 保号登录完成</b>\n状态: ${{ job.status }}\n时间: $(date '+%Y-%m-%d %H:%M:%S') UTC\n\n无截图生成（可能脚本未执行到截图步骤或全部失败）"
          fi

      - name: 清理临时文件（可选）
        if: always()
        run: |
          echo "清理完成，无需额外操作"
