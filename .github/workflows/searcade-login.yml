name: Searcade 保号登录

on:
  schedule:
    - cron: '6 6 */3 * *'    # 每3天运行一次
  workflow_dispatch:         # 支持手动触发

jobs:
  login:
    runs-on: ubuntu-latest

    steps:
      - name: 签出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 新增：恢复登录状态缓存，避免频繁触发 CF 验证
      - name: 恢复 Session 缓存
        uses: actions/cache@v3
        with:
          path: searcade_auth_state.json
          key: searcade-auth-${{ github.run_id }}
          restore-keys: |
            searcade-auth-

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install playwright requests playwright-stealth==1.0.6; fi
          npx playwright install chromium --with-deps

      - name: 创建截图目录
        run: mkdir -p screenshots

      - name: 运行登录脚本
        env:
          SEARCADE_ACCOUNTS: ${{ secrets.SEARCADE_ACCOUNTS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python login.py

      - name: 上传所有截图作为 artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: searcade-login-screenshots
          path: screenshots/*.png
          retention-days: 7

      - name: 发送截图到 Telegram
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # 检查是否有 png 文件
          if ls screenshots/*.png 1> /dev/null 2>&1; then
            for file in screenshots/*.png; do
              filename=$(basename "$file")
              curl -s -F chat_id="$TELEGRAM_CHAT_ID" \
                   -F caption="Searcade 运行记录 | $filename" \
                   -F photo=@"$file" \
                   https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendPhoto
              sleep 1
            done
          else
            echo "没有发现截图，发送纯文本通知"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                 -d chat_id="$TELEGRAM_CHAT_ID" \
                 -d text="Searcade 保号任务已执行，未产生新截图 (状态: ${{ job.status }})"
          fi
